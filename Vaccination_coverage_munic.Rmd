---
title: "Vaccination_coverage"
author: "S.W.F.  van Rijk"
date: "1-4-2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 

```{r cars}
getwd()
```

## 

```{r Packages, include=FALSE}
if (!require("easypackages")) install.packages("easypackages") #easy package manager

#Set up and data analysis packages
if (!require("tidyverse")) install.packages("tidyverse") #main data science packages

#Some GIS other analyses packages 
if (!require("sf")) install.packages("sf") #main GIS package
if (!require("sp")) install.packages("sp") #needed for some GIS operation, will not be in use from 2023
if (!require("spdep")) install.packages("spdep") #neighborhood analysis in R
if (!require("spatialreg")) install.packages("spatialreg") #spatial modelling such as lag, error
if (!require("spgwr")) install.packages("spgwr") #GWR modelling
if (!require("RColorBrewer")) install.packages("RColorBrewer") # getting interesting color
if (!require("tmap")) install.packages("tmap") # Mapping package
if (!require("mapview")) install.packages("mapview") # Mapping package
if (!require("car")) install.packages("car") #some base regression functions
if (!require("cowplot")) install.packages("cowplot") #some base regression functions
if (!require("leafsync")) install.packages("leafsync") #using with mapview
if (!require("leaflet.extras2")) install.packages("leaflet.extras2") #using with mapview

#load libraries

easypackages::packages ("sf", "sp", "spdep", "spatialreg", "spgwr", "tmap", "mapview", "car", "RColorBrewer", "tidyverse", 
                        "cowplot", "leafsync", "leaflet.extras2", "mapview")
library(readxl)
library(sqldf)
library(ISOweek)
library(sf)
#clean your environment
rm(list=ls())
```

## Reading polygons

```{r}

neigh <- st_read("data/wijken_onshore.gpkg", layer = "wijken_onshore")


names(neigh)

neigh <- neigh[,c("WK_CODE","WK_NAAM","GM_CODE","GM_NAAM","Shape_Area","geom")]

# Map
neigh_map <- mapview::mapview(neigh,
                              col.regions=rev(brewer.pal(11, "RdYlGn")),
                              layer.name = 'Neighborhoods'
                              )
neigh_map

```

## Read data

```{r}

# neighborhood demographic data
neigh_data <- read_excel("data/kwb-2020.xls", sheet = "KWB2020")
# metadata
neigh_meta <- read_excel("data/kwb-variables.xlsx", sheet="kwb-variables")

# filtering
neigh_data <- neigh_data %>% subset(recs=='Gemeente') # filter to only 'wijk' regions
neigh_data[,7:119] <- lapply(neigh_data[,7:119], gsub, pattern = ",", replacement = ".") # comma separators to dots
neigh_data[,7:119] <- neigh_data[,7:119] %>% mutate_if(is.character,as.numeric) # set variables to numeric

var_to_keep <- (neigh_meta %>% subset(Include==1))$Variabelenaam # subset to variables to keep
neigh_data <- neigh_data %>% select(var_to_keep) # filter data to variables to keep

# normalizing
var_to_norm <- neigh_meta %>% subset(`Need to normalise`==1 & Include==1) %>% select(c('Variabelenaam','Normalisatie'))

neigh_data[1,'a_inw']

for(row in 1:nrow(var_to_norm)){
  var <- var_to_norm[row,'Variabelenaam'][[1]]
  norm <- var_to_norm[row,'Normalisatie'][[1]]
  neigh_data[,var] <- neigh_data[,var]/neigh_data[,norm]
}


# municipality vaccination data
vaccine_mun <- read_delim("data/COVID-19_vaccinatiegraad_per_gemeente_per_week_leeftijd.csv", delim=";")
vaccine_mun[,8:9] <- lapply(vaccine_mun[,8:9], gsub, pattern = ">=", replacement = "") # remove bigger than signs
vaccine_mun[,8:9] <- vaccine_mun[,8:9] %>% mutate_if(is.character,as.numeric) # set variables to numeric

vaccine_mun[vaccine_mun == 9999] <- NA # make hidden missing values no longer hidden

vaccine_mun <- vaccine_mun %>% 
  subset(Date_of_statistics=='2022-03-14') %>% 
  mutate(coverage_partly_norm = ((Vaccination_coverage_partly) - mean(Vaccination_coverage_partly,na.rm=TRUE)) / sd(Vaccination_coverage_partly,na.rm=TRUE),
         coverage_completed_norm= ((Vaccination_coverage_completed) - mean(Vaccination_coverage_completed, na.rm=TRUE))/sd(Vaccination_coverage_completed, na.rm = TRUE))

mean(vaccine_mun$Vaccination_coverage_partly, na.rm=TRUE)
sd(vaccine_mun$Vaccination_coverage_partly, na.rm=TRUE)

mean(vaccine_mun$Vaccination_coverage_partly, na.rm=TRUE)
sd(vaccine_mun$Vaccination_coverage_partly, na.rm=TRUE)


# info on religions per municipality
religion_data <- read_excel("data/edit for R - Religie en kerkbezoek naar gemeente 2010-2014.xls", sheet = "Tabel_R")
# convert municipality code to correct format
religion_data$Gemcode <- as.character(religion_data$Gemcode) %>%
  lapply(str_pad, width = 4, side = "left", pad = "0")
religion_data$Gemcode <- paste("GM", religion_data$Gemcode, sep = "")



```

## Delete outlier neighborhoods?


```{r}
# Delete where a_inw == 0, causes NaNs and Inf numbers through divide by zero
# not applicable for municipalities, lowest is 947
neigh_data_filt <- neigh_data %>% filter(a_inw != 0)

  # maybe remove all neigh lower than 50 people?
  # ... %>% filter(a_inw >= 50)


```


## Join datasets

```{r}

data_compl <- sp::merge(x = vaccine_mun, 
                        y = neigh_data_filt,
                        by.x = 'Region_code',
                        by.y = 'gwb_code')

data_compl <- left_join(x = data_compl, y = religion_data, by = c("Region_code" = "Gemcode"))


```


## investigate religion per municipality


```{r}
# cor(data[, (ncol(data) - 10) : ncol(data)], data$coverage_completed_norm, use = "complete.obs")

data <-subset(data_compl, Age_group!="12+") #remove 12+, since it's the combination of 12-17 and 18+

data %>% group_by(Age_group) %>%
  group_map(~ cor(.x[, (ncol(.x) - 10) : ncol(.x)], .x$coverage_completed_norm, use = "complete.obs"))

ggplot(data, aes(x = Gereformeerd, y = coverage_completed_norm, color = Age_group)) +
  geom_point()

```

