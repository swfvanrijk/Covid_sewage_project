---
title: "Vaccination_coverage"
author: "S.W.F.  van Rijk"
date: "1-4-2022"
output: html_document
---

## 

```{r}
getwd()
```

## 

```{r Packages, include=FALSE}
if (!require("easypackages")) install.packages("easypackages") #easy package manager

#Set up and data analysis packages
if (!require("tidyverse")) install.packages("tidyverse") #main data science packages

#Some GIS other analyses packages 
if (!require("sf")) install.packages("sf") #main GIS package
if (!require("sp")) install.packages("sp") #needed for some GIS operation, will not be in use from 2023
if (!require("spdep")) install.packages("spdep") #neighborhood analysis in R
if (!require("spatialreg")) install.packages("spatialreg") #spatial modelling such as lag, error
if (!require("spgwr")) install.packages("spgwr") #GWR modelling
if (!require("RColorBrewer")) install.packages("RColorBrewer") # getting interesting color
if (!require("tmap")) install.packages("tmap") # Mapping package
if (!require("mapview")) install.packages("mapview") # Mapping package
if (!require("car")) install.packages("car") #some base regression functions
if (!require("cowplot")) install.packages("cowplot") #some base regression functions
if (!require("leafsync")) install.packages("leafsync") #using with mapview
if (!require("leaflet.extras2")) install.packages("leaflet.extras2") #using with mapview

#load libraries

easypackages::packages ("sf", "sp", "spdep", "spatialreg", "spgwr", "tmap", "mapview", "car", "RColorBrewer", "tidyverse", 
                        "cowplot", "leafsync", "leaflet.extras2", "mapview")

library(mice)
library(corrplot)
library(caret)
library(data.table)
require(reshape2)


#clean your environment
rm(list=ls())
```


## Read data


```{r municipalities}

# OUTCOME (vaccination coverage) DATA
munic_vac_data <- read_delim("data/Municipalities data/COVID-19_vaccinatiegraad_per_gemeente_per_week_leeftijd.csv", delim=";")


# MUNICAPALITY FUSIONS DATA
# to do !!!



# DEMOGRAPHIC DATA
munic_data <- read_delim("data/Municipalities data/Kerncijfers Gemeenten 2020.csv", delim=";")
munic_demo_meta <- read_delim("data/Municipalities data/Kerncijfers Gemeente Variabelen.csv", delim=";")

# correlation with gp distance
a = cor(munic_data %>% select_if(is.numeric), munic_data$`AfstandTotHuisartsenpraktijk_209`,use="complete.obs")


# rename variables
setnames(munic_data, old = munic_demo_meta$`Variable name`, new = munic_demo_meta$Meaning)



# filter to vars to keep
munic_data <- munic_data[,
                         # filter meta to variables to include
                         munic_demo_meta %>% subset(`Include in model`==1) %>%
                           .$`Meaning`] %>%
                         subset(!is.na(TotaleBevolking))


# merge EDUCATION DATA
munic_data <- merge(x = munic_data,
                    y = read_delim("data/Municipalities data/Opleiding Gemeente 2019.csv", delim=";"),
                    by.x='RegioS',
                    by.y='GM_CODE',
                    all.x = TRUE)



# merge VACCINATION COVERAGE DATA
#munic_data <- merge(x = munic_data,
#                    y = munic_vac_data %>% subset(Age_group == '12-17') %>% 
#                      summarise(Region_code,
#                                Vaccination_completely_12_17 = Vaccination_coverage_completed,
#                                Vaccination_partly_12_17 = Vaccination_coverage_partly),
#                    by.x = 'RegioS',
#                    by.y = 'Region_code')


munic_data <- merge(x = munic_data,
                    y = munic_vac_data %>% subset(Age_group == '18+') %>% summarise(Region_code,
                                                                   `Vaccination_completely_18` = Vaccination_coverage_completed,
                                                                   `Vaccination_partly_18` = Vaccination_coverage_partly),
                    by.x = 'RegioS',
                    by.y = 'Region_code')

# merge RELIGION DATA

munic_data <- merge(x = munic_data,
                    y = read_delim("data/Municipalities data/Kerkelijke gezindte en kerkbezoek naar gemeenten.csv", delim = ";"),
                    by.x = 'RegioS',
                    by.y = 'GM_CODE')


summary(munic_data)







```

```{r normalising}

munic_data <- munic_data %>% mutate(#Mannen = Mannen/ TotaleBevolking * 100, 
                                    #Vrouwen = Vrouwen / TotaleBevolking * 100,
                                    
                                    #Ongehuwd = Ongehuwd / TotaleBevolking * 100,
                                    #Gehuwd_ = Gehuwd / TotaleBevolking * 100,
                                    #Gescheiden = Gescheiden / TotaleBevolking * 100,
                                    #Verweduwd = Verweduwd / TotaleBevolking * 100,
                                    
                                    ZiektenVanHartEnVaatstelsel = ZiektenVanHartEnVaatstelsel / TotaleBevolking * 100,
                                    ZiektenVanAdemhalingsstelsel = ZiektenVanAdemhalingsstelsel / TotaleBevolking * 100,
                                    #UitwendigeDoodsoorzaken = UitwendigeDoodsoorzaken / TotaleBevolking * 100,
                                    #OverigeDoodsoorzaken = OverigeDoodsoorzaken / TotaleBevolking * 100,
                                    
                                    #WAOUitkering = WAOUitkering / TotaleBevolking * 100,
                                    #WIAUitkeringWGARegeling = WIAUitkeringWGARegeling / TotaleBevolking * 100,
                                    #WajongUitkering = WajongUitkering / TotaleBevolking * 100,
                                    #AOW = AOW / TotaleBevolking * 100,
                                    
                                    LowEducation = LowEducation / TotaleBevolking * 100,
                                    MiddleEducation = MiddleEducation / TotaleBevolking * 100,
                                    HighEducation = HighEducation / TotaleBevolking * 100)


```





## Correlation

```{r}

#test_var <- munic_data %>% select_if(is.numeric) %>% names()


test_var  <- c('Vaccination_completely_18',
    #'TotaalMetMigratieachtergrond',
    'WesterseMigratieachtergrond',
    'TotaalNietWesterseMigratieachtergrond',
    #'TotaalNietWesterseMigratieachtergrond',
  # household
   'HuishoudensZonderKinderen',
    #'AfstandTotKinderdagverblijf',
    'Bevolkingsdichtheid',
  # Availability of healthcare
    'AfstandTotHuisartsenpraktijk',
  # Education
    'LowEducation',
    #MiddleEducation +
    'HighEducation',
  # Religion
    'KerkbezoekMeerDan1KeerPerMaand', 
    'GereformeerdeKerken',
    'Islam',
    'anders' 
  )



# normalise to [0,1]
munic_data[,test_var] <- munic_data[,test_var] / 100

corr <- cor(munic_data[,test_var],use="complete.obs")


c <- {corrplot(corr, order = "hclust",method="color", tl.cex=0.5,tl.col = 'black');  recordPlot()}

ggsave("correlation-munic.png", plot = replayPlot(c))


# correlation with outcome
cor(munic_data[,test_var],munic_data$`Vaccination_completely_18+`,use="complete.obs")


summary(munic_data[,test_var])

ggplot(data = melt(munic_data[,test_var[2:10]]), aes(x=variable, y=value)) + 
  geom_boxplot() + 
  xlab('Variable name') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


# check missing data pattern
md.pattern(munic_data[,test_var],rotate.names = TRUE)

```
## Adding spatial data

```{r}

# complete cases
data_compl  <- munic_data[munic_data %>% complete.cases(),] 

z_data_compl <- data_compl %>% mutate_if(is.numeric, scale)

# merge SPATIAL DATA
data_compl <- sp::merge(x = st_read("data/gemeente_onshore.gpkg", layer = "gemeente_onshore") %>% mutate(code=paste0('GM',code)),
                        y = data_compl,
                        by.x = 'code',
                        by.y = 'RegioS',
                        all = FALSE)

z_data_compl <- sp::merge(x = st_read("data/gemeente_onshore.gpkg", layer = "gemeente_onshore") %>% mutate(code=paste0('GM',code)),
                        y = z_data_compl,
                        by.x = 'code',
                        by.y = 'RegioS',
                        all = FALSE)

summary(z_data_compl)

```




## Linear model and Morran's I

```{r}

# basic equation
lm_eq <-  `Vaccination_completely_18` ~ 
    #TotaalMetMigratieachtergrond +
    WesterseMigratieachtergrond +
    TotaalNietWesterseMigratieachtergrond +
    #TotaalNietWesterseMigratieachtergrond  +
  # Availability of healthcare
    AfstandTotHuisartsenpraktijk +
  #Bevolkingsdichtheid +
  # household
    HuishoudensZonderKinderen +
  # Education
    LowEducation +
    #MiddleEducation +
    HighEducation +
  # Religion
    KerkbezoekMeerDan1KeerPerMaand +
    #GeenKerkelijkeGezindte +
    #WelKerkelijkeGezindte +
    #RoomsKatholiek +
    #Protestants +
    #NederlandsHervormd +
    GereformeerdeKerken +
    #ProtestantseKerkNederland +
    Islam +
    #Joods +
    #Hindoe +
    #Boeddhist +
    anders 

vif(lm(lm_eq,data = z_data_compl))

```


```{r}
#creating adjacency matrix
data_nbq <- poly2nb(data_compl, queen=TRUE) #Queen’s Contiguity neighborhood
summary(data_nbq)

data_nbq_w <- nb2listw(data_nbq, style="W", zero.policy = TRUE) #Queen’s neighborhood weights
summary(data_nbq_w, zero.policy = TRUE)

#for plotting
coordsW <- data_compl%>%
  st_centroid()%>%
  st_geometry()

plot(data_nbq, st_geometry(coordsW), col="red")

```




## Spatial lag linear model

```{r spatial lag}

#running spatial lag model with same weight matrix created previously
spa_lagmodel = lagsarlm (lm_eq, data = z_data_compl, listw= data_nbq_w, zero.policy = TRUE)
summary(spa_lagmodel, Nagelkerke=T)

```




```{r residual error}

#check residual autocorrelation
mc_global <-moran.mc(spa_lagmodel$residuals, data_nbq_w, 2999, alternative="greater", zero.policy = TRUE)

plot(mc_global)
mc_global

```


```{r}

#add the residual to polygon and plot
data_compl$res_slm <- residuals(spa_lagmodel)

#plot using t-map
qtm(data_compl, "res_slm",  fill.palette = brewer.pal(11, "RdYlGn"),borders=NULL, fill.style="fixed", fill.breaks=c(-6:3))
tmap_save(filename=paste0(getwd(),"/figures/res_lag_mun.png"))

qtm(data_compl, "AfstandTotHuisartsenpraktijk",  fill.palette = brewer.pal(11, "RdYlGn"))
tmap_save(filename=paste0(getwd(),"/figures/dis_GP_map.png"))

```


## GWR model on municipalities

```{r}

data_sp <- as_Spatial(z_data_compl)
#find the optimum bandwidth distance for fixed kernel using the gwr.sel() function from spgwr package
fbw <- gwr.sel(lm_eq, 
               data = data_sp,
               longlat = TRUE,
               adapt = FALSE, 
               gweight = gwr.Gauss, 
               verbose = T)

```
```{r}
fb_gwr <- gwr(lm_eq, 
              data = data_sp,
              longlat = TRUE,
              bandwidth = fbw, 
              gweight = gwr.Gauss,
              hatmatrix=TRUE, 
              se.fit=TRUE)

#summary of the model
fb_gwr


?gwr
```


```{r}

#Extract the modeled relations for gwr object
fb_gwr_out <- as.data.frame(fb_gwr$SDF)

ggplot(data = melt(fb_gwr_out[,2:11]), aes(x=variable, y=value)) + 
  geom_boxplot() + 
  xlab('Variable coefficient') + 
  ylab('Estimate') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  geom_hline(yintercept = 0) + theme(axis.text = element_text(size=16),axis.title = element_text(size=16))
ggsave(file=paste0(getwd(),"/figures/gwr_var_mun.png"),width = 7, height = 6)


#join that with our main polygon data frame for the R2
data_compl$fmb_localR2 <- fb_gwr_out$localR2



qtm(data_compl, "fmb_localR2", fill.palette = brewer.pal(11, "RdYlGn"))
tmap_save(filename=paste0(getwd(),"/figures/gwr_mun_locR2.png"))

#join that with our main polygon data frame for Green space availability
data_compl$fcoef_AfstandTotHuisartsenpraktijk = fb_gwr_out$AfstandTotHuisartsenpraktijk

coef_map <- mapview::mapview(data_compl, 
                             zcol = "fcoef_AfstandTotHuisartsenpraktijk", 
                             col.regions=brewer.pal(11, "RdYlGn"))

coef_map

```






```{r}

#adaptive kernel
abw <- gwr.sel (lm_eq, 
              data = data_sp,
              adapt = TRUE, 
              gweight = gwr.Gauss)



```

```{r}
#Fitting the adaptive Kernel GWR
ab_gwr <- gwr(lm_eq, 
              data = data_sp,
              longlat = TRUE,
              adapt = abw, 
              gweight = gwr.Gauss,
              hatmatrix=TRUE, 
              se.fit=TRUE)

#summary of the model
ab_gwr

```

```{r}

#adaptive GWR results in data frame
ab_gwr_out <- as.data.frame(ab_gwr$SDF)

#join the local R2 for each model to each neighborhood
data_compl$amb_localR2 <- ab_gwr_out$localR2

```



```{r}


sigPlot <- function(var,gwr_out){
  #estimate the t-value for green space availability variable for fixed kernel model
  t = gwr_out[,var] / gwr_out[,paste0(var,'_se')]

  #categorize the t-value to statistical significance
  data_compl[,paste0(var,'_cat')] <- cut(t,
                             breaks=c(min(t), -1.96, 1.96, max(t)),
                             labels=c("sig","nonsig", "sig"))
  
  p <- qtm(data_compl, paste0(var,'_cat'))
  tmap_save(p, filename=paste0(getwd(),"/figures/sig_dis_",var,'.png'))
  return(p)
  
}

coeffPlot <- function(var,gwr_out){
  p <- qtm(data_compl, var)
  tmap_save(p, filename=paste0(getwd(),"/figures/coeff",var,'.png'))
  return(p)
  
}


for(var in test_var[2:11]){
  print(var)
  sigPlot(var,ab_gwr_out)
  
}

for(var in test_var[2:11]){
  print(var)
  coeffPlot(var,ab_gwr_out)
  
}

```










